# Claude Code Remote - 詳細仕様書

## 1. プロジェクト概要

### 1.1 目的
iPhoneやiPadからWindows PC上のClaude Codeを自然言語でリモート操作し、AIによるプログラミング支援を場所を問わず利用可能にする。

### 1.2 コアコンセプト
- **自然言語プログラミング**: 技術的なコマンドではなく、日常的な言葉でプログラミング
- **リモートアクセス**: 場所や端末を選ばずにAI開発環境を利用
- **リアルタイムフィードバック**: Claude Codeの処理状況をリアルタイムで確認

## 2. システムアーキテクチャ

### 2.1 全体構成
```
┌─────────────────┐
│  iPhone/iPad    │
│  (PWA/Safari)   │
└────────┬────────┘
         │ HTTPS/WSS
         ↓
┌─────────────────┐
│  Node.js Server │
│  (Windows PC)   │
└────────┬────────┘
         │ Child Process
         ↓
┌─────────────────┐
│  Claude Code    │
│  (AI Engine)    │
└─────────────────┘
```

### 2.2 技術スタック
- **フロントエンド**: React + TypeScript + PWA
- **バックエンド**: Node.js + Express + WebSocket
- **AI エンジン**: Claude Code (claude.exe)
- **認証**: JWT + bcrypt
- **通信**: HTTPS + WSS (WebSocket Secure)

## 3. 機能仕様

### 3.1 認証機能
- **ログイン画面**
  - ユーザー名/パスワード入力
  - サーバーURL設定（デフォルト値プリセット）
  - 認証情報の保存（localStorage）
  
- **セキュリティ**
  - パスワードのbcryptハッシュ化
  - JWT トークン（24時間有効）
  - HTTPS通信必須（本番環境）

### 3.2 コマンド実行機能

#### 3.2.1 サポートする自然言語コマンド例

**ファイル操作**
- "新しいPythonファイルを作成して"
- "config.jsonの内容を表示して"
- "すべてのTypeScriptファイルをリストアップして"

**コード生成**
- "REST APIのエンドポイントを作成して"
- "Reactコンポーネントでユーザー登録フォームを作って"
- "データベース接続のヘルパー関数を書いて"

**デバッグ・修正**
- "このエラーを修正して"
- "関数にエラーハンドリングを追加して"
- "パフォーマンスを改善して"

**プロジェクト管理**
- "新しいNext.jsプロジェクトをセットアップして"
- "必要な依存関係をインストールして"
- "テストを実行して"

#### 3.2.2 コマンド処理フロー
1. ユーザーが自然言語でコマンド入力
2. WebSocket経由でサーバーに送信
3. サーバーがClaude Codeプロセスを起動
4. コマンドをClaude Codeに送信
5. Claude Codeの出力をリアルタイムでストリーミング
6. 完了通知を送信

### 3.3 UI/UX仕様

#### 3.3.1 モバイル最適化
- **レスポンシブデザイン**: iPhone SE〜iPad Pro対応
- **タッチ操作**: 大きめのボタン、スワイプ操作
- **仮想キーボード対応**: 入力フィールドの自動フォーカス

#### 3.3.2 画面構成
```
┌─────────────────────┐
│  ステータスバー      │ (接続状態、認証状態)
├─────────────────────┤
│                     │
│  ターミナル出力      │ (Claude Codeの応答)
│                     │
├─────────────────────┤
│  コマンド入力        │ (自然言語入力)
├─────────────────────┤
│  クイックアクション  │ (よく使うコマンド)
└─────────────────────┘
```

#### 3.3.3 ターミナル表示
- **カラーコーディング**
  - 青: コマンド
  - 緑: 成功メッセージ
  - 赤: エラー
  - 白: 通常出力
- **自動スクロール**: 新しい出力で自動的に最下部へ
- **コピー機能**: 長押しで出力をコピー

### 3.4 WebSocket通信仕様

#### 3.4.1 メッセージフォーマット

**クライアント → サーバー**
```json
{
  "type": "auth",
  "token": "JWT_TOKEN"
}

{
  "type": "command",
  "text": "Create a Python script that sorts files by date"
}

{
  "type": "interrupt"
}

{
  "type": "ping"
}
```

**サーバー → クライアント**
```json
{
  "type": "auth",
  "success": true
}

{
  "type": "output",
  "text": "Creating Python script...\n"
}

{
  "type": "error",
  "text": "Error message"
}

{
  "type": "complete",
  "code": 0
}

{
  "type": "pong"
}
```

#### 3.4.2 接続管理
- **自動再接続**: 接続断時の自動リトライ（指数バックオフ）
- **ハートビート**: 30秒ごとのping/pong
- **タイムアウト**: 5分間無操作で自動切断

### 3.5 Claude Code統合仕様

#### 3.5.1 プロセス管理
- **単一プロセス**: 同時実行は1つのClaude Codeプロセスのみ
- **プロセス制御**: 新しいコマンドで既存プロセスを終了
- **タイムアウト**: 5分で自動終了
- **リソース制限**: メモリ使用量、CPU使用率の監視

#### 3.5.2 入出力処理
- **標準入力**: 自然言語コマンドを直接送信
- **標準出力**: リアルタイムでクライアントにストリーミング
- **標準エラー**: エラーメッセージとして処理
- **文字エンコーディング**: UTF-8統一（Windows環境でも）

### 3.6 セキュリティ仕様

#### 3.6.1 認証・認可
- **多要素認証**: 将来的に実装予定
- **IPホワイトリスト**: 特定のIPアドレスのみ許可
- **レート制限**: 1分間に30コマンドまで

#### 3.6.2 コマンド制限
- **ブラックリスト**: 危険なコマンドの実行を防止
  - システムファイルの削除
  - ネットワーク設定の変更
  - レジストリの編集
- **サンドボックス**: 特定のディレクトリ内のみ操作可能

#### 3.6.3 通信セキュリティ
- **TLS 1.2以上**: 暗号化通信
- **証明書ピンニング**: 中間者攻撃対策
- **CORS設定**: 許可されたオリジンのみ

## 4. パフォーマンス要件

### 4.1 レスポンスタイム
- **初回接続**: 3秒以内
- **コマンド実行開始**: 1秒以内
- **出力表示**: リアルタイム（100ms以内）

### 4.2 同時接続数
- **開発環境**: 1接続
- **本番環境**: 最大5接続（将来的に拡張）

### 4.3 データ転送
- **最大出力サイズ**: 1MB/コマンド
- **WebSocketメッセージサイズ**: 64KB/メッセージ

## 5. エラーハンドリング

### 5.1 エラーの種類と対処

| エラー種別 | 原因 | ユーザーへの表示 | 自動リカバリ |
|-----------|------|----------------|-------------|
| 認証エラー | トークン期限切れ | "セッションが期限切れです" | 再ログイン画面表示 |
| 接続エラー | ネットワーク断 | "接続が切断されました" | 自動再接続（3回まで） |
| プロセスエラー | Claude Code異常終了 | "処理中にエラーが発生しました" | プロセス再起動 |
| タイムアウト | 処理時間超過 | "処理がタイムアウトしました" | プロセス強制終了 |

### 5.2 ログ記録
- **アクセスログ**: 全接続・コマンド実行を記録
- **エラーログ**: エラー詳細とスタックトレース
- **監査ログ**: セキュリティ関連イベント

## 6. 設定・カスタマイズ

### 6.1 環境変数 (.env)
```env
# サーバー設定
PORT=9001
HOST=0.0.0.0

# セキュリティ
JWT_SECRET=your-secret-key
JWT_EXPIRY=24h

# Claude Code
CLAUDE_CODE_PATH=claude
CLAUDE_CODE_TIMEOUT=300000

# 制限
MAX_OUTPUT_SIZE=1048576
RATE_LIMIT_WINDOW=60000
RATE_LIMIT_MAX=30
```

### 6.2 クライアント設定
- **テーマ**: ダーク/ライトモード
- **フォントサイズ**: 小/中/大
- **通知設定**: 音/振動/なし
- **言語**: 日本語/英語

## 7. 将来の拡張計画

### 7.1 機能拡張
- **音声入力**: Siriショートカット連携
- **ファイル共有**: iCloud Drive統合
- **コラボレーション**: 複数ユーザーでの共同作業
- **AI学習**: ユーザーの使用パターンを学習

### 7.2 プラットフォーム拡張
- **Android対応**: React Native版の開発
- **デスクトップアプリ**: Electron版
- **VS Code拡張**: 統合開発環境との連携

## 8. テスト仕様

### 8.1 単体テスト
- **認証機能**: JWT生成・検証
- **WebSocket通信**: メッセージ送受信
- **プロセス管理**: 起動・終了・タイムアウト

### 8.2 統合テスト
- **エンドツーエンド**: ログインからコマンド実行まで
- **負荷テスト**: 同時接続・大量出力
- **セキュリティテスト**: ペネトレーションテスト

### 8.3 ユーザビリティテスト
- **実機テスト**: iPhone各モデルでの動作確認
- **ネットワーク環境**: 3G/4G/5G/Wi-Fi
- **使用シナリオ**: 実際の使用ケースでのテスト

## 9. デプロイメント

### 9.1 開発環境
- ローカルPC上で全コンポーネントを実行
- 自己署名証明書でHTTPS

### 9.2 本番環境
- **サーバー**: Windows Server / AWS EC2
- **SSL証明書**: Let's Encrypt
- **監視**: PM2 + CloudWatch
- **バックアップ**: 日次自動バックアップ

## 10. サポート・メンテナンス

### 10.1 ドキュメント
- インストールガイド
- 使用マニュアル
- API仕様書
- トラブルシューティング

### 10.2 更新ポリシー
- **セキュリティパッチ**: 即時適用
- **機能アップデート**: 月次リリース
- **破壊的変更**: 3ヶ月前に通知

---

**バージョン**: 1.0.0  
**最終更新**: 2025年8月3日  
**作成者**: Claude Code Assistant